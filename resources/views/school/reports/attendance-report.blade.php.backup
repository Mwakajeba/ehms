@extends('layouts.main')

@section('title', 'Attendance Reports & Analysis')

@push('styles')
<link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<style>
    .stats-card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-2px);
    }
    .stats-icon {
        font-size: 2rem;
        opacity: 0.8;
    }
    .filter-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 20px;
    }
</style>
@endpush

@section('content')
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-chart-line mr-2"></i>Attendance Reports & Analysis
            </h1>
            <p class="text-muted">Comprehensive attendance tracking and analytics</p>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <form id="attendanceFilterForm" class="row g-3">
            <div class="col-md-3">
                <label for="class_id" class="form-label">Class</label>
                <select class="form-select select2" id="class_id" name="class_id">
                    <option value="">All Classes</option>
                    @foreach($classes as $class)
                        <option value="{{ $class->id }}">{{ $class->name }}</option>
                    @endforeach
                </select>
            </div>
            <div class="col-md-3">
                <label for="stream_id" class="form-label">Stream</label>
                <select class="form-select select2" id="stream_id" name="stream_id">
                    <option value="">All Streams</option>
                    @foreach($streams as $stream)
                        <option value="{{ $stream->id }}">{{ $stream->name }}</option>
                    @endforeach
                </select>
            </div>
            <div class="col-md-3">
                <label for="academic_year_id" class="form-label">Academic Year</label>
                <select class="form-select select2" id="academic_year_id" name="academic_year_id">
                    <option value="">All Years</option>
                    @foreach($academicYears as $year)
                        <option value="{{ $year->id }}">{{ $year->year_name }}</option>
                    @endforeach
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Date Range</label>
                <div class="input-group">
                    <input type="date" class="form-control" id="start_date" name="start_date"
                           value="{{ date('Y-m-01') }}">
                    <span class="input-group-text">to</span>
                    <input type="date" class="form-control" id="end_date" name="end_date"
                           value="{{ date('Y-m-t') }}">
                </div>
            </div>
            <div class="col-12">
                <button type="button" class="btn btn-primary" id="applyFilters">
                    <i class="fas fa-search mr-2"></i>Apply Filters
                </button>
                <button type="button" class="btn btn-secondary" id="resetFilters">
                    <i class="fas fa-undo mr-2"></i>Reset
                </button>
                <div class="float-end">
                    <div class="btn-group">
                        <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportReport('summary', 'pdf')">
                                <i class="fas fa-file-pdf mr-2"></i>PDF Report</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportReport('summary', 'excel')">
                                <i class="fas fa-file-excel mr-2"></i>Excel Report</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportReport('summary', 'csv')">
                                <i class="fas fa-file-csv mr-2"></i>CSV Report</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Sessions</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ $summaryStats['total_sessions'] }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Overall Attendance Rate</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ $summaryStats['overall_attendance_rate'] }}%</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-percentage fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total Present</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ number_format($summaryStats['total_present']) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card stats-card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Total Absent</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ number_format($summaryStats['total_absent']) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Stats Row -->
    <div class="row mb-4">
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card stats-card border-left-secondary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                                Late Arrivals</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ number_format($summaryStats['total_late']) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card stats-card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Sick Leave</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ number_format($summaryStats['total_sick']) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-medkit fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card stats-card border-left-dark shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-dark text-uppercase mb-1">
                                Total Students</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ number_format($summaryStats['total_students']) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Attendance Trends (Last 30 Days)</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="attendanceTrendsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Class-wise Attendance</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="classWiseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Detailed Attendance Sessions</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="attendanceTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Class</th>
                            <th>Stream</th>
                            <th>Academic Year</th>
                            <th>Total Students</th>
                            <th>Present</th>
                            <th>Absent</th>
                            <th>Late</th>
                            <th>Sick</th>
                            <th>Attendance Rate</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
@endsection

@push('scripts')
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
$(document).ready(function() {
    // Initialize Select2
    $('.select2').select2({
        theme: 'bootstrap-5',
        width: '100%'
    });

    // Initialize DataTable
    const attendanceTable = $('#attendanceTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '{{ route("school.reports.attendance.summary-data") }}',
            data: function(d) {
                d.class_id = $('#class_id').val();
                d.stream_id = $('#stream_id').val();
                d.academic_year_id = $('#academic_year_id').val();
                d.start_date = $('#start_date').val();
                d.end_date = $('#end_date').val();
            }
        },
        columns: [
            { data: 'session_date_formatted', name: 'session_date' },
            { data: 'class_name', name: 'class.name' },
            { data: 'stream_name', name: 'stream.name' },
            { data: 'academic_year_name', name: 'academicYear.year_name' },
            { data: 'total_students', name: 'total_students' },
            { data: 'present', name: 'present' },
            { data: 'absent', name: 'absent' },
            { data: 'late', name: 'late' },
            { data: 'sick', name: 'sick' },
            { data: 'attendance_rate', name: 'attendance_rate' },
            {
                data: null,
                orderable: false,
                searchable: false,
                render: function(data, type, row) {
                    return `
                        <button class="btn btn-sm btn-info" onclick="viewSessionDetails(${row.id})">
                            <i class="fas fa-eye"></i> View
                        </button>
                    `;
                }
            }
        ],
        responsive: true,
        pageLength: 25,
        order: [[0, 'desc']]
    });

    // Apply filters
    $('#applyFilters').on('click', function() {
        attendanceTable.ajax.reload();
        loadCharts();
        loadSummaryStats();
    });

    // Reset filters
    $('#resetFilters').on('click', function() {
        $('#attendanceFilterForm')[0].reset();
        $('.select2').trigger('change');
        attendanceTable.ajax.reload();
        loadCharts();
        loadSummaryStats();
    });

    // Load initial charts
    loadCharts();
});

function loadCharts() {
    // Load attendance trends
    $.get('{{ route("school.reports.attendance.trends") }}', {
        class_id: $('#class_id').val(),
        stream_id: $('#stream_id').val(),
        academic_year_id: $('#academic_year_id').val(),
        start_date: $('#start_date').val(),
        end_date: $('#end_date').val(),
        days: 30
    })
    .done(function(data) {
        renderTrendsChart(data);
    });

    // Load class-wise stats
    $.get('{{ route("school.reports.attendance.class-wise") }}', {
        class_id: $('#class_id').val(),
        stream_id: $('#stream_id').val(),
        academic_year_id: $('#academic_year_id').val(),
        start_date: $('#start_date').val(),
        end_date: $('#end_date').val()
    })
    .done(function(data) {
        renderClassWiseChart(data);
    });
}

function loadSummaryStats() {
    // Reload the page to get updated summary stats
    // This is a simple approach - in production, you might want to make an AJAX call
    location.reload();
}

function renderTrendsChart(data) {
    const ctx = document.getElementById('attendanceTrendsChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(item => new Date(item.date).toLocaleDateString()),
            datasets: [{
                label: 'Attendance Rate (%)',
                data: data.map(item => item.attendance_rate),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Attendance Rate (%)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Date'
                    }
                }
            }
        }
    });
}

function renderClassWiseChart(data) {
    const ctx = document.getElementById('classWiseChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(item => item.class_name),
            datasets: [{
                label: 'Attendance Rate (%)',
                data: data.map(item => item.attendance_rate),
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Attendance Rate (%)'
                    }
                }
            }
        }
    });
}

function viewSessionDetails(sessionId) {
    // Implement session details modal
    alert('Session details for ID: ' + sessionId);
}

function exportReport(type, format) {
    const params = new URLSearchParams({
        type: type,
        format: format,
        class_id: $('#class_id').val(),
        stream_id: $('#stream_id').val(),
        academic_year_id: $('#academic_year_id').val(),
        start_date: $('#start_date').val(),
        end_date: $('#end_date').val()
    });

    window.open('{{ route("school.reports.attendance.export") }}?' + params.toString(), '_blank');
}
</script>
@endpush